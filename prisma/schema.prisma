// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  transactions StockTransaction[]
  priceHistory PriceHistory[]
  notifications Notification[]
  activityLogs ActivityLog[]
  systemSettings SystemSetting[]

  @@map("users")
}

model Product {
  id            String   @id @default(cuid())
  sku           String   @unique
  brand         String
  name          String
  category      String
  size          String
  paintColor    String?
  unit          String
  purchasePrice Float?
  sellingPrice  Float?
  minimumStock  Int?
  reorderPoint  Int?     @default(0)
  lastPriceUpdate DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactionItems TransactionItem[]
  stockMovements   StockMovement[]
  categories       ProductCategory[]
  priceHistory     PriceHistory[]

  @@index([sku])
  @@index([brand, category])
  @@index([name])
  @@index([category])
  @@index([minimumStock])
  @@index([reorderPoint])
  @@index([updatedAt])
  @@map("products")
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions StockTransaction[]

  @@index([name])
  @@index([createdAt])
  @@map("suppliers")
}

model StockTransaction {
  id              String   @id @default(cuid())
  referenceNumber String   @unique
  type            String   // 'IN', 'OUT', 'ADJUST', 'RETURN_IN', 'RETURN_OUT'
  transactionDate DateTime
  supplierId      String?
  userId          String
  notes           String?
  totalValue      Float?
  createdAt       DateTime @default(now())

  supplier Supplier? @relation(fields: [supplierId], references: [id])
  user     User      @relation(fields: [userId], references: [id])
  items    TransactionItem[]
  movements StockMovement[]

  @@index([transactionDate])
  @@index([type])
  @@index([createdAt])
  @@index([supplierId])
  @@index([type, transactionDate])
  @@index([transactionDate, createdAt])
  @@map("stock_transactions")
}

model TransactionItem {
  id            String   @id @default(cuid())
  transactionId String
  productId     String
  quantity      Int
  unitCost      Float?
  unitPrice     Float?
  createdAt     DateTime @default(now())

  transaction StockTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product          @relation(fields: [productId], references: [id])

  @@index([transactionId])
  @@index([productId])
  @@map("transaction_items")
}

model StockMovement {
  id             String   @id @default(cuid())
  productId      String
  transactionId  String
  movementType   String   // 'IN', 'OUT', 'ADJUST', 'RETURN_IN', 'RETURN_OUT'
  quantityBefore Int
  quantityChange Int
  quantityAfter  Int
  createdAt      DateTime @default(now())

  product     Product          @relation(fields: [productId], references: [id])
  transaction StockTransaction @relation(fields: [transactionId], references: [id])

  @@index([productId, createdAt])
  @@index([transactionId])
  @@index([createdAt])
  @@index([movementType])
  @@index([productId, createdAt, quantityAfter])
  @@map("stock_movements")
}

// Category Management Models
model Category {
  id        String   @id @default(cuid())
  name      String
  parentId  String?
  parent    Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  ProductCategory[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([parentId])
  @@index([name])
  @@map("categories")
}

model ProductCategory {
  id         String  @id @default(cuid())
  productId  String
  categoryId String
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([productId, categoryId])
  @@map("product_categories")
}

// Price History Model
model PriceHistory {
  id            String   @id @default(cuid())
  productId     String
  priceType     String   // 'PURCHASE' | 'SELLING'
  oldPrice      Float?
  newPrice      Float
  effectiveDate DateTime @default(now())
  reason        String?
  userId        String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([productId, priceType])
  @@index([effectiveDate])
  @@map("price_history")
}

// Notification Models
model NotificationRule {
  id         String   @id @default(cuid())
  name       String
  type       String   // 'LOW_STOCK' | 'PRICE_CHANGE' | 'SYSTEM_EVENT'
  conditions String   // JSON string
  actions    String   // JSON string
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@map("notification_rules")
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  data      String?  // JSON string
  isRead    Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Activity Log Model
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // 'CREATE' | 'UPDATE' | 'DELETE' | 'LOGIN' | etc.
  entityType  String?  // 'PRODUCT' | 'SUPPLIER' | 'TRANSACTION' | etc.
  entityId    String?
  details     String?  // JSON string
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
  
  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([entityType, entityId])
  @@map("activity_logs")
}

// System Settings Model
model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   // JSON string
  description String?
  category    String   // 'BUSINESS' | 'NOTIFICATION' | 'UI' | 'BACKUP'
  updatedAt   DateTime @updatedAt
  updatedBy   String
  user        User     @relation(fields: [updatedBy], references: [id])
  
  @@index([category])
  @@map("system_settings")
}